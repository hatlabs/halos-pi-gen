name: HALPI OS CI Build

run-name: |
  ${{ github.event_name == 'pull_request' && format('ðŸ‘· PR #{0} build - {1}', github.event.pull_request.number, github.event.pull_request.title) || '' }}
  ${{ github.event_name == 'workflow_dispatch' && 'ðŸš€ Manual build' || '' }}

on:
  pull_request:
    branches:
      - 'main'
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  image-builder:
    name: "${{ matrix.name }}"
    runs-on: ubuntu-latest-arm64
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: Raspios-HALPI2
            config: config.raspios-halpi2
            release: trixie
            filename_prefix: raspios-halpi2
            enabled: false
          - name: Raspios-lite-HALPI2
            config: config.raspios-lite-halpi2
            release: trixie
            filename_prefix: raspios-lite-halpi2
            enabled: false
          - name: Halos-HALPI2
            config: config.halos-halpi2
            release: trixie
            filename_prefix: halos-halpi2
            enabled: true
          - name: Halos-Desktop-HALPI2
            config: config.halos-desktop-halpi2
            release: trixie
            filename_prefix: halos-desktop-halpi2
            enabled: false
          - name: Halos-Marine-HALPI2
            config: config.halos-marine-halpi2
            release: trixie
            filename_prefix: halos-marine-halpi2
            enabled: true
          - name: Halos-Desktop-Marine-HALPI2
            config: config.halos-desktop-marine-halpi2
            release: trixie
            filename_prefix: halos-desktop-marine-halpi2
            enabled: true

    steps:
      - name: â¬‡ Checkout the halos repository
        if: matrix.enabled != false
        uses: actions/checkout@v4

      - name: â¬‡ Checkout pi-gen
        if: matrix.enabled != false
        uses: actions/checkout@v4
        with:
          repository: RPi-Distro/pi-gen
          ref: arm64
          path: pi-gen

      - name: ðŸ”§ Prepare
        if: matrix.enabled != false
        id: prep
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils quilt parted qemu-utils qemu-user-static debootstrap zerofree zip dosfstools libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc kmod kpartx arch-test xxd pigz
          ISODATE=$(date +%Y-%m-%d)
          echo "ISODATE=$ISODATE" >> $GITHUB_ENV
          IMG_FILENAME="${{ matrix.filename_prefix }}_${{ matrix.release }}_${ISODATE}"
          echo "IMG_FILENAME=$IMG_FILENAME" >> $GITHUB_ENV

      - name: ðŸ‘· Build
        if: matrix.enabled != false
        run: |
          cp -R stage-* pi-gen/
          touch pi-gen/stage5/SKIP
          touch pi-gen/stage{2,4}/SKIP_IMAGES
          cp ${{ matrix.config }} pi-gen/config
          cd pi-gen
          sudo RELEASE='${{ matrix.release }}' IMG_FILENAME=${{ env.IMG_FILENAME }} ARCHIVE_FILENAME=${{ env.IMG_FILENAME }} ./build-docker.sh

      - name: ðŸ“¦ Upload
        if: matrix.enabled != false
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMG_FILENAME }}
          path: pi-gen/deploy/*.xz
          retention-days: 3
