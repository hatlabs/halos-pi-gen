name: HALPI OS CI Release

on:
  push:
    branches:
      - 'main'
    # Optionally, you can also trigger on tags if you want
    # tags:
    #   - 'v*'
  workflow_dispatch:

jobs:
  github_publish:
    name: ðŸš€ Draft GitHub Releases
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ Checkout HALPI OS image repository
        uses: actions/checkout@v4

      - name: ðŸ”Ž Find latest successful workflow run ID for pull_request.yml
        id: find_run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pull_request.yml',
              status: 'success',
            });
            if (!runs.data.workflow_runs.length) {
              throw new Error('No successful workflow runs found for pull_request.yml');
            }
            // Sort by created_at to get the most recent run
            const sortedRuns = runs.data.workflow_runs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            core.setOutput('run_id', sortedRuns[0].id);

      - name: ðŸ’¾ Download build artifacts from last successful pull_request.yml run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: all-artifacts
          merge-multiple: true
          run-id: ${{ steps.find_run.outputs.run_id }}

      - name: ðŸ·ï¸ Calculate next release tag
        id: calc_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const version = fs.readFileSync('VERSION', 'utf8').trim();

            // Get all tags matching this version's pattern
            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Find highest build number for this version
            const datePattern = new RegExp(`^v${version.replace(/\./g, '\\.')}-(\\d+)$`);
            let maxBuild = 0;

            for (const tag of tags.data) {
              const match = tag.name.match(datePattern);
              if (match) {
                const buildNum = parseInt(match[1]);
                if (buildNum > maxBuild) {
                  maxBuild = buildNum;
                }
              }
            }

            const nextBuild = maxBuild + 1;
            const newTag = `v${version}-${nextBuild}`;

            core.setOutput('tag', newTag);
            core.setOutput('version', version);
            core.setOutput('build', nextBuild);

      - name: ðŸ—‘ï¸ Delete existing draft releases
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            console.log(`Found ${releases.data.length} total releases`);

            for (const release of releases.data) {
              console.log(`Release: ${release.name || release.tag_name} - Draft: ${release.draft}, Prerelease: ${release.prerelease}`);

              // Strict equality check and explicit verification
              if (release.draft === true && release.prerelease === false) {
                console.log(`Deleting draft release: ${release.name || release.tag_name || release.id}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
              } else if (release.draft === true && release.prerelease === true) {
                console.log(`Skipping prerelease draft: ${release.name || release.tag_name}`);
              } else {
                console.log(`Skipping published release: ${release.name || release.tag_name}`);
              }
            }

      - name: ðŸ“‹ Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## HaLOS Images - Build ${{ steps.calc_tag.outputs.build }}

          Automated build from commit ${{ github.sha }}

          ### Included Images

          **HALPI2 Hardware Variants** (with HALPI2 drivers):
          - Raspios-HALPI2
          - Raspios-lite-HALPI2
          - Halos-HALPI2
          - Halos-Desktop-HALPI2
          - Halos-Marine-HALPI2
          - Halos-Desktop-Marine-HALPI2
          - Halos-Desktop-Marine-HALPI2-AP

          **Generic Raspberry Pi Variants**:
          - Halos-RPI
          - Halos-Desktop-RPI
          - Halos-Marine-RPI
          - Halos-Desktop-Marine-RPI

          ### Installation

          Flash images using [Raspberry Pi Imager](https://www.raspberrypi.org/software/).

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.calc_tag.outputs.tag }}
          name: "HaLOS Images - ${{ steps.calc_tag.outputs.tag }}"
          body_path: release_notes.md
          files: all-artifacts/*
          draft: true
