name: HALPI OS Build & Release

run-name: |
  ${{ github.event_name == 'push' && 'ðŸ—ï¸ Main branch build' || '' }}
  ${{ github.event_name == 'workflow_dispatch' && 'ðŸš€ Manual build' || '' }}

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

concurrency:
  group: ${{ github.repository }}-main-release
  cancel-in-progress: false

jobs:
  image-builder:
    name: "${{ matrix.name }}"
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Raspios-HALPI2
            config: config.raspios-halpi2
            release: trixie
            filename_prefix: Raspios-HALPI2
            enabled: true
          - name: Raspios-Lite-HALPI2
            config: config.raspios-lite-halpi2
            release: trixie
            filename_prefix: Raspios-Lite-HALPI2
            enabled: true
          - name: Halos-HALPI2
            config: config.halos-halpi2
            release: trixie
            filename_prefix: halos-halpi2
            enabled: true
          - name: Halos-Desktop-HALPI2
            config: config.halos-desktop-halpi2
            release: trixie
            filename_prefix: halos-desktop-halpi2
            enabled: true
          - name: Halos-Marine-HALPI2
            config: config.halos-marine-halpi2
            release: trixie
            filename_prefix: halos-marine-halpi2
            enabled: true
          - name: Halos-Desktop-Marine-HALPI2
            config: config.halos-desktop-marine-halpi2
            release: trixie
            filename_prefix: halos-desktop-marine-halpi2
            enabled: true
          - name: Halos-Desktop-Marine-HALPI2-AP
            config: config.halos-desktop-marine-halpi2-ap
            release: trixie
            filename_prefix: halos-desktop-marine-halpi2-ap
            enabled: true
          - name: Halos-RPI
            config: config.halos-rpi
            release: trixie
            filename_prefix: halos-rpi
            enabled: true
          - name: Halos-Desktop-RPI
            config: config.halos-desktop-rpi
            release: trixie
            filename_prefix: halos-desktop-rpi
            enabled: true
          - name: Halos-Marine-RPI
            config: config.halos-marine-rpi
            release: trixie
            filename_prefix: halos-marine-rpi
            enabled: true
          - name: Halos-Desktop-Marine-RPI
            config: config.halos-desktop-marine-rpi
            release: trixie
            filename_prefix: halos-desktop-marine-rpi
            enabled: true

    steps:
      - name: â¬‡ Checkout the halos repository
        if: matrix.enabled != false
        uses: actions/checkout@v4

      - name: â¬‡ Checkout pi-gen
        if: matrix.enabled != false
        uses: actions/checkout@v4
        with:
          repository: RPi-Distro/pi-gen
          ref: arm64
          path: pi-gen

      - name: ðŸ”§ Prepare
        if: matrix.enabled != false
        id: prep
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils quilt parted qemu-utils qemu-user-static debootstrap zerofree zip dosfstools libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc kmod kpartx arch-test xxd pigz
          HALOS_VERSION=$(cat VERSION)
          IMG_FILENAME="${{ matrix.filename_prefix }}_${{ matrix.release }}_${HALOS_VERSION}"
          echo "IMG_FILENAME=$IMG_FILENAME" >> $GITHUB_ENV

      - name: ðŸ‘· Build
        if: matrix.enabled != false
        run: |
          cp VERSION pi-gen/VERSION
          cp -R stage-* pi-gen/
          touch pi-gen/stage5/SKIP
          touch pi-gen/stage{2,4}/SKIP_IMAGES
          cp ${{ matrix.config }} pi-gen/config
          cd pi-gen
          sudo RELEASE='${{ matrix.release }}' GIT_HASH=${{ github.sha }} IMG_FILENAME=${{ env.IMG_FILENAME }} ARCHIVE_FILENAME=${{ env.IMG_FILENAME }} ./build-docker.sh

      - name: ðŸ“¦ Upload
        if: matrix.enabled != false
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMG_FILENAME }}
          path: pi-gen/deploy/*.xz
          retention-days: 3

  release:
    name: ðŸš€ Draft GitHub Release
    needs: [image-builder]
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ’¾ Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          merge-multiple: true

      - name: ðŸ·ï¸ Calculate next release tag
        id: calc_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const version = fs.readFileSync('VERSION', 'utf8').trim();

            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const datePattern = new RegExp(`^v${version.replace(/\./g, '\\.')}-(\\d+)$`);
            let maxBuild = 0;

            for (const tag of tags.data) {
              const match = tag.name.match(datePattern);
              if (match) {
                const buildNum = parseInt(match[1]);
                if (buildNum > maxBuild) {
                  maxBuild = buildNum;
                }
              }
            }

            const nextBuild = maxBuild + 1;
            const newTag = `v${version}-${nextBuild}`;

            core.setOutput('tag', newTag);
            core.setOutput('version', version);
            core.setOutput('build', nextBuild);

      - name: ðŸ—‘ï¸ Delete existing draft releases
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            console.log(`Found ${releases.data.length} total releases`);

            for (const release of releases.data) {
              console.log(`Release: ${release.name || release.tag_name} - Draft: ${release.draft}, Prerelease: ${release.prerelease}`);

              if (release.draft === true && release.prerelease === false) {
                console.log(`Deleting draft release: ${release.name || release.tag_name || release.id}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
              } else if (release.draft === true && release.prerelease === true) {
                console.log(`Skipping prerelease draft: ${release.name || release.tag_name}`);
              } else {
                console.log(`Skipping published release: ${release.name || release.tag_name}`);
              }
            }

      - name: ðŸ“‹ Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## HaLOS Images - Build ${{ steps.calc_tag.outputs.build }}

          Automated build from commit ${{ github.sha }}

          ### Included Images

          **HALPI2 Hardware Variants** (with HALPI2 drivers):
          - Raspios-HALPI2
          - Raspios-lite-HALPI2
          - Halos-HALPI2
          - Halos-Desktop-HALPI2
          - Halos-Marine-HALPI2
          - Halos-Desktop-Marine-HALPI2
          - Halos-Desktop-Marine-HALPI2-AP

          **Generic Raspberry Pi Variants**:
          - Halos-RPI
          - Halos-Desktop-RPI
          - Halos-Marine-RPI
          - Halos-Desktop-Marine-RPI

          ### Installation

          Flash images using [Raspberry Pi Imager](https://www.raspberrypi.org/software/).
          EOF

      - name: ðŸ“¦ Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.calc_tag.outputs.tag }}
          name: "HaLOS Images - ${{ steps.calc_tag.outputs.tag }}"
          body_path: release_notes.md
          files: all-artifacts/*
          draft: true
